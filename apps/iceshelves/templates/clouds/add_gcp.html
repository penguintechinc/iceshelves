[[extend 'layout.html']]

<section class="hero is-success">
  <div class="hero-body">
    <div class="container">
      <h1 class="title">
        <span class="icon"><i class="fab fa-google"></i></span>
        Add GCP Cloud
      </h1>
      <p class="subtitle">Configure Google Cloud Platform Compute Engine deployment target</p>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">

        <!-- Progress Steps -->
        <nav class="breadcrumb is-centered" aria-label="breadcrumbs">
          <ul id="wizard-breadcrumb">
            <li class="is-active" data-step="1">
              <a><span class="icon"><i class="fas fa-info-circle"></i></span><span>Basic Info</span></a>
            </li>
            <li data-step="2">
              <a><span class="icon"><i class="fas fa-key"></i></span><span>Credentials</span></a>
            </li>
            <li data-step="3">
              <a><span class="icon"><i class="fas fa-cog"></i></span><span>Configuration</span></a>
            </li>
            <li data-step="4">
              <a><span class="icon"><i class="fas fa-check"></i></span><span>Review</span></a>
            </li>
          </ul>
        </nav>

        <form id="gcp-wizard-form" method="POST" action="[[=URL('clouds/add/gcp')]]">

          <!-- Step 1: Basic Information -->
          <div class="wizard-step" data-step="1">
            <div class="box">
              <h2 class="title is-4">GCP Cloud - Basic Information</h2>

              <div class="field">
                <label class="label">Cloud Name *</label>
                <div class="control has-icons-left">
                  <input class="input" type="text" name="name" id="cloud-name" required
                         placeholder="e.g., GCP Production US-Central">
                  <span class="icon is-small is-left">
                    <i class="fas fa-cloud"></i>
                  </span>
                </div>
                <p class="help">Unique name to identify this GCP cloud</p>
              </div>

              <div class="field">
                <label class="label">Description</label>
                <div class="control">
                  <textarea class="textarea" name="description" id="cloud-description"
                            placeholder="Optional description"></textarea>
                </div>
              </div>

              <div class="field">
                <label class="label">GCP Zone *</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select name="zone" id="gcp-zone" required>
                      <option value="">Select GCP zone...</option>
                      <optgroup label="US">
                        <option value="us-central1-a">us-central1-a (Iowa)</option>
                        <option value="us-central1-b">us-central1-b (Iowa)</option>
                        <option value="us-central1-c">us-central1-c (Iowa)</option>
                        <option value="us-east1-b">us-east1-b (South Carolina)</option>
                        <option value="us-east1-c">us-east1-c (South Carolina)</option>
                        <option value="us-west1-a">us-west1-a (Oregon)</option>
                        <option value="us-west1-b">us-west1-b (Oregon)</option>
                      </optgroup>
                      <optgroup label="Europe">
                        <option value="europe-west1-b">europe-west1-b (Belgium)</option>
                        <option value="europe-west1-c">europe-west1-c (Belgium)</option>
                        <option value="europe-west2-a">europe-west2-a (London)</option>
                        <option value="europe-west3-a">europe-west3-a (Frankfurt)</option>
                        <option value="europe-west4-a">europe-west4-a (Netherlands)</option>
                      </optgroup>
                      <optgroup label="Asia">
                        <option value="asia-east1-a">asia-east1-a (Taiwan)</option>
                        <option value="asia-southeast1-a">asia-southeast1-a (Singapore)</option>
                        <option value="asia-northeast1-a">asia-northeast1-a (Tokyo)</option>
                        <option value="asia-south1-a">asia-south1-a (Mumbai)</option>
                      </optgroup>
                    </select>
                  </div>
                </div>
                <p class="help">Select the GCP zone for deployments</p>
              </div>
            </div>

            <div class="buttons is-right">
              <a href="[[=URL('clouds/add')]]" class="button">
                <span class="icon"><i class="fas fa-times"></i></span>
                <span>Cancel</span>
              </a>
              <button type="button" class="button is-success" onclick="goToStep(2)">
                <span>Next</span>
                <span class="icon"><i class="fas fa-arrow-right"></i></span>
              </button>
            </div>
          </div>

          <!-- Step 2: Credentials -->
          <div class="wizard-step" data-step="2" style="display:none;">
            <div class="box">
              <h2 class="title is-4">GCP Service Account</h2>
              <p class="subtitle is-6">Select existing service account or add new</p>

              <div class="field">
                <label class="label">Credential Source</label>
                <div class="control">
                  <label class="radio">
                    <input type="radio" name="credential_source" value="saved" checked
                           onchange="toggleGCPCredentialSource()">
                    Use saved service account
                  </label>
                  <label class="radio">
                    <input type="radio" name="credential_source" value="new"
                           onchange="toggleGCPCredentialSource()">
                    Upload new service account JSON
                  </label>
                </div>
              </div>

              <!-- Saved Credentials Selector -->
              <div id="gcp-saved-credentials-section">
                <div class="field">
                  <label class="label">Select GCP Service Account *</label>
                  <div class="control">
                    <div class="select is-fullwidth">
                      <select name="credential_id" id="gcp-credential-select">
                        <option value="">Loading credentials...</option>
                      </select>
                    </div>
                  </div>
                  <p class="help">
                    <a href="[[=URL('credentials/manage')]]" target="_blank">
                      <span class="icon"><i class="fas fa-external-link-alt"></i></span>
                      Manage credentials in your profile
                    </a>
                  </p>
                </div>
              </div>

              <!-- New Service Account Section -->
              <div id="gcp-new-credentials-section" style="display:none;">
                <article class="message is-warning">
                  <div class="message-body">
                    <strong>Note:</strong> It's recommended to add service accounts in your
                    <a href="[[=URL('credentials/manage')]]" target="_blank">profile</a> first.
                  </div>
                </article>

                <article class="message is-info">
                  <div class="message-body">
                    <p><strong>How to create a Service Account:</strong></p>
                    <ol>
                      <li>Go to GCP Console → IAM & Admin → Service Accounts</li>
                      <li>Create or select a service account</li>
                      <li>Grant it "Compute Admin" role</li>
                      <li>Click "Keys" → "Add Key" → "Create new key"</li>
                      <li>Select JSON format → Download</li>
                    </ol>
                  </div>
                </article>

                <div class="field">
                  <label class="label">Upload Service Account JSON *</label>
                  <div class="file has-name is-fullwidth">
                    <label class="file-label">
                      <input class="file-input" type="file" name="gcp_json_file"
                             id="new-gcp-json-file" accept=".json"
                             onchange="handleNewGCPJsonUpload(event)">
                      <span class="file-cta">
                        <span class="icon"><i class="fas fa-upload"></i></span>
                        <span class="file-label">Choose JSON file...</span>
                      </span>
                      <span class="file-name" id="new-gcp-file-name">No file selected</span>
                    </label>
                  </div>
                </div>

                <div class="field">
                  <label class="label">Or Paste JSON Directly</label>
                  <div class="control">
                    <textarea class="textarea" name="gcp_json_content"
                              id="new-gcp-json-textarea" rows="8"
                              placeholder='{"type": "service_account", "project_id": "...", ...}'></textarea>
                  </div>
                </div>

                <div id="new-gcp-json-validation" style="display:none;"></div>
              </div>
            </div>

            <div class="buttons is-right">
              <button type="button" class="button" onclick="goToStep(1)">
                <span class="icon"><i class="fas fa-arrow-left"></i></span>
                <span>Back</span>
              </button>
              <button type="button" class="button is-success" onclick="goToStep(3)">
                <span>Next</span>
                <span class="icon"><i class="fas fa-arrow-right"></i></span>
              </button>
            </div>
          </div>

          <!-- Step 3: Configuration -->
          <div class="wizard-step" data-step="3" style="display:none;">
            <div class="box">
              <h2 class="title is-4">Default VM Configuration</h2>
              <p class="subtitle is-6">Set default values for new Compute Engine VMs</p>

              <div class="field">
                <label class="label">Project ID</label>
                <div class="control">
                  <input class="input" type="text" name="project_id" id="gcp-project-id"
                         placeholder="Will be extracted from service account"
                         readonly>
                </div>
                <p class="help">Automatically populated from service account JSON</p>
              </div>

              <div class="field">
                <label class="label">Default Machine Type</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select name="machine_type" id="machine-type" onchange="updateGCPPricing()">
                      <optgroup label="General Purpose (E2) - Cost Optimized">
                        <option value="e2-micro" selected>e2-micro - $6/mo* (2 vCPU, 1 GB RAM) - Free Tier Eligible</option>
                        <option value="e2-small">e2-small - $12/mo* (2 vCPU, 2 GB RAM)</option>
                        <option value="e2-medium">e2-medium - $24/mo* (2 vCPU, 4 GB RAM)</option>
                        <option value="e2-standard-2">e2-standard-2 - $48/mo* (2 vCPU, 8 GB RAM)</option>
                      </optgroup>
                      <optgroup label="General Purpose (N2)">
                        <option value="n2-standard-2">n2-standard-2 - 2 vCPU, 8 GB RAM</option>
                        <option value="n2-standard-4">n2-standard-4 - 4 vCPU, 16 GB RAM</option>
                      </optgroup>
                      <optgroup label="Compute Optimized (C2)">
                        <option value="c2-standard-4">c2-standard-4 - 4 vCPU, 16 GB RAM</option>
                        <option value="c2-standard-8">c2-standard-8 - 8 vCPU, 32 GB RAM</option>
                      </optgroup>
                      <optgroup label="Memory Optimized (M2)">
                        <option value="m2-ultramem-208">m2-ultramem-208 - 208 vCPU, 5888 GB RAM</option>
                      </optgroup>
                    </select>
                  </div>
                </div>
                <p class="help" id="gcp-pricing-estimate">*Estimated with sustained use discounts</p>
              </div>

              <div class="columns">
                <div class="column">
                  <div class="field">
                    <label class="label">Image Project</label>
                    <div class="control">
                      <div class="select is-fullwidth">
                        <select name="image_project" id="image-project">
                          <option value="ubuntu-os-cloud" selected>Ubuntu</option>
                          <option value="debian-cloud">Debian</option>
                          <option value="centos-cloud">CentOS</option>
                          <option value="rhel-cloud">Red Hat Enterprise Linux</option>
                          <option value="fedora-cloud">Fedora</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="column">
                  <div class="field">
                    <label class="label">Image Family</label>
                    <div class="control">
                      <input class="input" type="text" name="image_family"
                             value="ubuntu-2404-lts"
                             placeholder="ubuntu-2404-lts">
                    </div>
                  </div>
                </div>
              </div>

              <div class="field">
                <label class="label">Network</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select name="network" id="gcp-network">
                      <option value="default" selected>default</option>
                    </select>
                  </div>
                </div>
                <p class="help">
                  <button type="button" class="button is-small is-success is-light"
                          onclick="loadGCPNetworks()">
                    <span class="icon"><i class="fas fa-sync"></i></span>
                    <span>Load Networks from GCP</span>
                  </button>
                </p>
              </div>

              <div class="field">
                <label class="label">Firewall Tags</label>
                <div class="control">
                  <div class="field is-grouped is-grouped-multiline" id="firewall-tags-container">
                    <div class="control">
                      <div class="tags has-addons">
                        <span class="tag is-link">http-server</span>
                        <a class="tag is-delete" onclick="removeTag(this)"></a>
                      </div>
                    </div>
                    <div class="control">
                      <div class="tags has-addons">
                        <span class="tag is-link">https-server</span>
                        <a class="tag is-delete" onclick="removeTag(this)"></a>
                      </div>
                    </div>
                  </div>
                  <input type="hidden" name="firewall_tags" id="firewall-tags-hidden" value="http-server,https-server">
                </div>
                <p class="help">
                  <button type="button" class="button is-small is-link is-light"
                          onclick="addFirewallTag()">
                    <span class="icon"><i class="fas fa-plus"></i></span>
                    <span>Add Tag</span>
                  </button>
                </p>
              </div>

              <div class="columns">
                <div class="column">
                  <div class="field">
                    <label class="label">Boot Disk Type</label>
                    <div class="control">
                      <div class="select is-fullwidth">
                        <select name="disk_type">
                          <option value="pd-standard">pd-standard (Standard HDD)</option>
                          <option value="pd-balanced" selected>pd-balanced (Balanced SSD)</option>
                          <option value="pd-ssd">pd-ssd (Performance SSD)</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="column">
                  <div class="field">
                    <label class="label">Disk Size (GB)</label>
                    <div class="control">
                      <input class="input" type="number" name="disk_size"
                             value="20" min="10" max="65536">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="buttons is-right">
              <button type="button" class="button" onclick="goToStep(2)">
                <span class="icon"><i class="fas fa-arrow-left"></i></span>
                <span>Back</span>
              </button>
              <button type="button" class="button is-success" onclick="goToStep(4)">
                <span>Next</span>
                <span class="icon"><i class="fas fa-arrow-right"></i></span>
              </button>
            </div>
          </div>

          <!-- Step 4: Review & Test -->
          <div class="wizard-step" data-step="4" style="display:none;">
            <div class="box">
              <h2 class="title is-4">Review & Test Connection</h2>

              <div class="notification is-success is-light">
                <h3 class="subtitle is-5">Configuration Summary</h3>
                <table class="table is-fullwidth">
                  <tbody>
                    <tr>
                      <th>Cloud Name:</th>
                      <td id="gcp-summary-name"></td>
                    </tr>
                    <tr>
                      <th>GCP Zone:</th>
                      <td id="gcp-summary-zone"></td>
                    </tr>
                    <tr>
                      <th>Project ID:</th>
                      <td id="gcp-summary-project"></td>
                    </tr>
                    <tr>
                      <th>Machine Type:</th>
                      <td id="gcp-summary-machine"></td>
                    </tr>
                    <tr>
                      <th>Disk:</th>
                      <td id="gcp-summary-disk"></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="field">
                <button type="button" class="button is-success is-fullwidth is-medium"
                        id="gcp-test-connection-btn" onclick="testGCPConnection()">
                  <span class="icon"><i class="fas fa-plug"></i></span>
                  <span>Test GCP Connection</span>
                </button>
              </div>

              <div id="gcp-test-results" style="display:none;"></div>
            </div>

            <div class="buttons is-right">
              <button type="button" class="button" onclick="goToStep(3)">
                <span class="icon"><i class="fas fa-arrow-left"></i></span>
                <span>Back</span>
              </button>
              <button type="submit" class="button is-success is-medium" id="gcp-save-btn" disabled>
                <span class="icon"><i class="fas fa-check"></i></span>
                <span>Save GCP Cloud</span>
              </button>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>
</section>

<script src="[[=URL('static', 'js/cloud-wizard.js')]]"></script>
<script>
// Load saved GCP credentials on page load
document.addEventListener('DOMContentLoaded', async function() {
  await loadSavedGCPCredentials();
});

// Handle new GCP JSON upload in wizard
function handleNewGCPJsonUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  document.getElementById('new-gcp-file-name').textContent = file.name;

  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;
    document.getElementById('new-gcp-json-textarea').value = content;
    validateNewGCPJson(content);
  };
  reader.readAsText(file);
}

function validateNewGCPJson(jsonContent) {
  const validationDiv = document.getElementById('new-gcp-json-validation');
  try {
    const json = JSON.parse(jsonContent);
    if (json.type === 'service_account' && json.project_id && json.private_key) {
      validationDiv.innerHTML = `
        <div class="notification is-success is-light">
          <span class="icon"><i class="fas fa-check"></i></span>
          Valid service account JSON (Project: ${json.project_id})
        </div>
      `;
      validationDiv.style.display = 'block';
      // Auto-populate project ID
      document.getElementById('gcp-project-id').value = json.project_id;
      return true;
    } else {
      throw new Error('Missing required fields');
    }
  } catch (error) {
    validationDiv.innerHTML = `
      <div class="notification is-danger is-light">
        <span class="icon"><i class="fas fa-times"></i></span>
        Invalid JSON: ${error.message}
      </div>
    `;
    validationDiv.style.display = 'block';
    return false;
  }
}

function toggleGCPCredentialSource() {
  const source = document.querySelector('input[name="credential_source"]:checked').value;
  document.getElementById('gcp-saved-credentials-section').style.display =
    source === 'saved' ? 'block' : 'none';
  document.getElementById('gcp-new-credentials-section').style.display =
    source === 'new' ? 'block' : 'none';
}
</script>

[[extend 'layout.html']]

<section class="hero is-info">
  <div class="hero-body">
    <div class="container">
      <h1 class="title">
        <span class="icon"><i class="fas fa-key"></i></span>
        Cloud Credentials
      </h1>
      <p class="subtitle">Manage your cloud provider access credentials</p>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">

    <!-- Action Buttons -->
    <div class="level">
      <div class="level-left">
        <div class="level-item">
          <div class="field has-addons">
            <p class="control">
              <button class="button is-primary" onclick="showAddCredentialModal('aws')">
                <span class="icon"><i class="fab fa-aws"></i></span>
                <span>Add AWS Credentials</span>
              </button>
            </p>
            <p class="control">
              <button class="button is-success" onclick="showAddCredentialModal('gcp')">
                <span class="icon"><i class="fab fa-google"></i></span>
                <span>Add GCP Credentials</span>
              </button>
            </p>
            <p class="control">
              <button class="button is-warning" onclick="showAddCredentialModal('ssh')">
                <span class="icon"><i class="fas fa-terminal"></i></span>
                <span>Add SSH Key</span>
              </button>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Credentials List -->
    <div class="box">
      <h2 class="title is-4">Your Credentials</h2>

      [[if not credentials:]]
        <div class="notification is-info is-light">
          <p class="has-text-centered">
            <span class="icon is-large"><i class="fas fa-info-circle fa-2x"></i></span>
          </p>
          <p class="has-text-centered">
            <strong>No credentials added yet</strong><br>
            Add cloud provider credentials to get started with multi-cloud deployments
          </p>
        </div>
      [[else:]]
        <table class="table is-fullwidth is-striped is-hoverable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Details</th>
              <th>Status</th>
              <th>Last Used</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            [[for cred in credentials:]]
            <tr>
              <td>
                <strong>[[=cred.name]]</strong>
                [[if cred.description:]]
                  <br><small class="has-text-grey">[[=cred.description]]</small>
                [[pass]]
              </td>
              <td>
                [[if cred.credential_type == 'aws':]]
                  <span class="tag is-info">
                    <span class="icon"><i class="fab fa-aws"></i></span>
                    <span>AWS</span>
                  </span>
                [[elif cred.credential_type == 'gcp':]]
                  <span class="tag is-success">
                    <span class="icon"><i class="fab fa-google"></i></span>
                    <span>GCP</span>
                  </span>
                [[elif cred.credential_type == 'ssh':]]
                  <span class="tag is-warning">
                    <span class="icon"><i class="fas fa-terminal"></i></span>
                    <span>SSH</span>
                  </span>
                [[pass]]
              </td>
              <td>
                [[if cred.credential_type == 'aws':]]
                  <small class="has-text-grey-dark">
                    Key ID: [[=cred.aws_access_key_id[:10]]]...
                  </small>
                [[elif cred.credential_type == 'gcp':]]
                  <small class="has-text-grey-dark">
                    Project: [[=cred.gcp_project_id or 'Unknown']]
                  </small>
                [[elif cred.credential_type == 'ssh':]]
                  <small class="has-text-grey-dark">
                    SSH Key Pair
                  </small>
                [[pass]]
                <br>
                <small class="has-text-grey">
                  Storage: [[=cred.storage_type.upper()]]
                  [[if cred.is_encrypted:]]
                    <span class="icon has-text-success" title="Encrypted">
                      <i class="fas fa-lock"></i>
                    </span>
                  [[pass]]
                </small>
              </td>
              <td>
                [[if cred.is_valid:]]
                  <span class="tag is-success">
                    <span class="icon"><i class="fas fa-check"></i></span>
                    <span>Valid</span>
                  </span>
                [[else:]]
                  <span class="tag is-danger" title="[[=cred.validation_error or 'Unknown error']]">
                    <span class="icon"><i class="fas fa-times"></i></span>
                    <span>Invalid</span>
                  </span>
                [[pass]]
              </td>
              <td>
                [[if cred.last_used:]]
                  <small>[[=cred.last_used.strftime('%Y-%m-%d %H:%M')]]</small>
                [[else:]]
                  <small class="has-text-grey">Never</small>
                [[pass]]
              </td>
              <td>
                <div class="buttons are-small">
                  <button class="button is-info is-light"
                          onclick="testCredential([[=cred.id]])"
                          title="Test Connection">
                    <span class="icon"><i class="fas fa-plug"></i></span>
                  </button>
                  <button class="button is-warning is-light"
                          onclick="editCredential([[=cred.id]])"
                          title="Edit">
                    <span class="icon"><i class="fas fa-edit"></i></span>
                  </button>
                  <button class="button is-danger is-light"
                          onclick="deleteCredential([[=cred.id]], '[[=cred.name]]')"
                          title="Delete">
                    <span class="icon"><i class="fas fa-trash"></i></span>
                  </button>
                </div>
              </td>
            </tr>
            [[pass]]
          </tbody>
        </table>
      [[pass]]
    </div>

    <!-- Security Notice -->
    <div class="notification is-warning is-light">
      <p class="has-text-weight-semibold">
        <span class="icon"><i class="fas fa-shield-alt"></i></span>
        Security Best Practices
      </p>
      <ul>
        <li>All credentials are encrypted at rest using AES-256</li>
        <li>AWS credentials should have minimal required permissions (EC2, VPC read/write)</li>
        <li>GCP service accounts should use least-privilege IAM roles</li>
        <li>Regularly rotate credentials and update them here</li>
        <li>Consider using external secrets managers (AWS Secrets Manager, GCP Secret Manager, Infisical)</li>
      </ul>
    </div>

  </div>
</section>

<!-- Add AWS Credential Modal -->
<div class="modal" id="aws-credential-modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head has-background-info">
      <p class="modal-card-title has-text-white">
        <span class="icon"><i class="fab fa-aws"></i></span>
        Add AWS Credentials
      </p>
      <button class="delete" aria-label="close" onclick="closeModal('aws-credential-modal')"></button>
    </header>
    <section class="modal-card-body">
      <form id="aws-credential-form" method="POST" action="[[=URL('credentials/add/aws')]]">

        <div class="field">
          <label class="label">Credential Name *</label>
          <div class="control has-icons-left">
            <input class="input" type="text" name="name" required
                   placeholder="e.g., AWS Production Account">
            <span class="icon is-small is-left">
              <i class="fas fa-tag"></i>
            </span>
          </div>
          <p class="help">A friendly name to identify these credentials</p>
        </div>

        <div class="field">
          <label class="label">Description</label>
          <div class="control">
            <textarea class="textarea" name="description" rows="2"
                      placeholder="Optional: Where/how these credentials are used"></textarea>
          </div>
        </div>

        <hr>

        <div class="field">
          <label class="label">AWS Access Key ID *</label>
          <div class="control has-icons-left">
            <input class="input" type="text" name="aws_access_key_id" required
                   pattern="AKIA[A-Z0-9]{16}"
                   placeholder="AKIAIOSFODNN7EXAMPLE">
            <span class="icon is-small is-left">
              <i class="fas fa-key"></i>
            </span>
          </div>
          <p class="help">Must start with AKIA (20 characters total)</p>
        </div>

        <div class="field">
          <label class="label">AWS Secret Access Key *</label>
          <div class="control has-icons-left has-icons-right">
            <input class="input" type="password" name="aws_secret_access_key" required
                   id="aws-secret-input"
                   placeholder="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY">
            <span class="icon is-small is-left">
              <i class="fas fa-lock"></i>
            </span>
            <span class="icon is-small is-right is-clickable"
                  onclick="togglePasswordVisibility('aws-secret-input')">
              <i class="fas fa-eye"></i>
            </span>
          </div>
          <p class="help">40 character secret access key</p>
        </div>

        <div class="field">
          <label class="label">Storage Location</label>
          <div class="control">
            <label class="radio">
              <input type="radio" name="storage_type" value="database" checked>
              Database (Encrypted)
            </label>
            <label class="radio">
              <input type="radio" name="storage_type" value="aws">
              AWS Secrets Manager
            </label>
            <label class="radio">
              <input type="radio" name="storage_type" value="infisical">
              Infisical
            </label>
          </div>
          <p class="help">Choose where to securely store these credentials</p>
        </div>

        <div class="field">
          <div class="control">
            <label class="checkbox">
              <input type="checkbox" name="test_before_save" checked>
              Test credentials before saving
            </label>
          </div>
        </div>

      </form>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" onclick="submitCredentialForm('aws')">
        <span class="icon"><i class="fas fa-save"></i></span>
        <span>Save Credentials</span>
      </button>
      <button class="button" onclick="closeModal('aws-credential-modal')">Cancel</button>
    </footer>
  </div>
</div>

<!-- Add GCP Credential Modal -->
<div class="modal" id="gcp-credential-modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head has-background-success">
      <p class="modal-card-title has-text-white">
        <span class="icon"><i class="fab fa-google"></i></span>
        Add GCP Credentials
      </p>
      <button class="delete" aria-label="close" onclick="closeModal('gcp-credential-modal')"></button>
    </header>
    <section class="modal-card-body">
      <form id="gcp-credential-form" method="POST" action="[[=URL('credentials/add/gcp')]]">

        <div class="field">
          <label class="label">Credential Name *</label>
          <div class="control has-icons-left">
            <input class="input" type="text" name="name" required
                   placeholder="e.g., GCP Production Project">
            <span class="icon is-small is-left">
              <i class="fas fa-tag"></i>
            </span>
          </div>
        </div>

        <div class="field">
          <label class="label">Description</label>
          <div class="control">
            <textarea class="textarea" name="description" rows="2"
                      placeholder="Optional description"></textarea>
          </div>
        </div>

        <hr>

        <div class="field">
          <label class="label">Upload Service Account JSON *</label>
          <div class="file has-name is-fullwidth">
            <label class="file-label">
              <input class="file-input" type="file" name="gcp_json_file"
                     id="gcp-json-file-input" accept=".json" required
                     onchange="handleGCPJsonFileUpload(event)">
              <span class="file-cta">
                <span class="icon"><i class="fas fa-upload"></i></span>
                <span class="file-label">Choose JSON file...</span>
              </span>
              <span class="file-name" id="gcp-file-name">No file selected</span>
            </label>
          </div>
        </div>

        <div class="field">
          <label class="label">Or Paste JSON Directly</label>
          <div class="control">
            <textarea class="textarea" name="gcp_json_content" id="gcp-json-textarea"
                      rows="8" placeholder='{"type": "service_account", "project_id": "...", ...}'></textarea>
          </div>
        </div>

        <div id="gcp-json-validation" style="display:none;"></div>

        <hr>

        <div class="field">
          <label class="label">Storage Location</label>
          <div class="control">
            <label class="radio">
              <input type="radio" name="storage_type" value="database" checked>
              Database (Encrypted)
            </label>
            <label class="radio">
              <input type="radio" name="storage_type" value="gcp">
              GCP Secret Manager
            </label>
            <label class="radio">
              <input type="radio" name="storage_type" value="infisical">
              Infisical
            </label>
          </div>
        </div>

        <div class="field">
          <div class="control">
            <label class="checkbox">
              <input type="checkbox" name="test_before_save" checked>
              Test credentials before saving
            </label>
          </div>
        </div>

      </form>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" onclick="submitCredentialForm('gcp')">
        <span class="icon"><i class="fas fa-save"></i></span>
        <span>Save Credentials</span>
      </button>
      <button class="button" onclick="closeModal('gcp-credential-modal')">Cancel</button>
    </footer>
  </div>
</div>

<!-- Add SSH Key Modal -->
<div class="modal" id="ssh-credential-modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head has-background-warning">
      <p class="modal-card-title has-text-dark">
        <span class="icon"><i class="fas fa-terminal"></i></span>
        Add SSH Key
      </p>
      <button class="delete" aria-label="close" onclick="closeModal('ssh-credential-modal')"></button>
    </header>
    <section class="modal-card-body">
      <form id="ssh-credential-form" method="POST" action="[[=URL('credentials/add/ssh')]]">

        <div class="field">
          <label class="label">Key Name *</label>
          <div class="control has-icons-left">
            <input class="input" type="text" name="name" required
                   placeholder="e.g., My SSH Key">
            <span class="icon is-small is-left">
              <i class="fas fa-tag"></i>
            </span>
          </div>
        </div>

        <div class="field">
          <label class="label">SSH Private Key *</label>
          <div class="control">
            <textarea class="textarea" name="ssh_private_key" required
                      rows="8" placeholder="-----BEGIN RSA PRIVATE KEY-----
...
-----END RSA PRIVATE KEY-----"></textarea>
          </div>
          <p class="help">PEM format private key</p>
        </div>

        <div class="field">
          <label class="label">SSH Public Key (Optional)</label>
          <div class="control">
            <textarea class="textarea" name="ssh_public_key"
                      rows="3" placeholder="ssh-rsa AAAAB3NzaC1yc2E..."></textarea>
          </div>
        </div>

        <div class="field">
          <label class="label">Key Passphrase (if encrypted)</label>
          <div class="control has-icons-left">
            <input class="input" type="password" name="ssh_passphrase"
                   placeholder="Leave blank if key has no passphrase">
            <span class="icon is-small is-left">
              <i class="fas fa-lock"></i>
            </span>
          </div>
        </div>

        <hr>

        <div class="field">
          <label class="label">Storage Location</label>
          <div class="control">
            <label class="radio">
              <input type="radio" name="storage_type" value="database" checked>
              Database (Encrypted)
            </label>
            <label class="radio">
              <input type="radio" name="storage_type" value="infisical">
              Infisical
            </label>
          </div>
        </div>

      </form>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-warning" onclick="submitCredentialForm('ssh')">
        <span class="icon"><i class="fas fa-save"></i></span>
        <span>Save SSH Key</span>
      </button>
      <button class="button" onclick="closeModal('ssh-credential-modal')">Cancel</button>
    </footer>
  </div>
</div>

<script>
// Modal management
function showAddCredentialModal(type) {
  const modal = document.getElementById(`${type}-credential-modal`);
  modal.classList.add('is-active');
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.remove('is-active');
}

// Toggle password visibility
function togglePasswordVisibility(inputId) {
  const input = document.getElementById(inputId);
  const icon = input.nextElementSibling.nextElementSibling.querySelector('i');
  if (input.type === 'password') {
    input.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

// GCP JSON file upload handling
function handleGCPJsonFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  document.getElementById('gcp-file-name').textContent = file.name;

  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;
    document.getElementById('gcp-json-textarea').value = content;
    validateGCPJson(content);
  };
  reader.readAsText(file);
}

function validateGCPJson(jsonContent) {
  const validationDiv = document.getElementById('gcp-json-validation');
  try {
    const json = JSON.parse(jsonContent);
    if (json.type === 'service_account' && json.project_id && json.private_key) {
      validationDiv.innerHTML = `
        <div class="notification is-success is-light">
          <span class="icon"><i class="fas fa-check"></i></span>
          Valid service account JSON (Project: ${json.project_id})
        </div>
      `;
      validationDiv.style.display = 'block';
      return true;
    } else {
      throw new Error('Missing required fields');
    }
  } catch (error) {
    validationDiv.innerHTML = `
      <div class="notification is-danger is-light">
        <span class="icon"><i class="fas fa-times"></i></span>
        Invalid service account JSON: ${error.message}
      </div>
    `;
    validationDiv.style.display = 'block';
    return false;
  }
}

// Submit credential form (async)
async function submitCredentialForm(type) {
  const form = document.getElementById(`${type}-credential-form`);
  const formData = new FormData(form);

  const button = event.target;
  button.classList.add('is-loading');

  try {
    const response = await fetch(form.action, {
      method: 'POST',
      body: formData
    });

    const result = await response.json();

    if (result.success) {
      // Close modal and reload page
      closeModal(`${type}-credential-modal`);
      location.reload();
    } else {
      alert(`Error: ${result.message}`);
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  } finally {
    button.classList.remove('is-loading');
  }
}

// Test credential
async function testCredential(credentialId) {
  const button = event.target.closest('button');
  button.classList.add('is-loading');

  try {
    const response = await fetch(`/api/credentials/${credentialId}/test`, {
      method: 'POST'
    });

    const result = await response.json();

    if (result.success) {
      alert(`✓ Credentials are valid!\n${result.message}`);
    } else {
      alert(`✗ Credentials failed validation:\n${result.message}`);
    }
  } catch (error) {
    alert(`Error testing credentials: ${error.message}`);
  } finally {
    button.classList.remove('is-loading');
  }
}

// Delete credential
async function deleteCredential(credentialId, credentialName) {
  if (!confirm(`Are you sure you want to delete "${credentialName}"?\n\nThis cannot be undone.`)) {
    return;
  }

  try {
    const response = await fetch(`/api/credentials/${credentialId}`, {
      method: 'DELETE'
    });

    const result = await response.json();

    if (result.success) {
      location.reload();
    } else {
      alert(`Error: ${result.message}`);
    }
  } catch (error) {
    alert(`Error deleting credential: ${error.message}`);
  }
}

// Edit credential
function editCredential(credentialId) {
  window.location.href = `/credentials/edit/${credentialId}`;
}
</script>

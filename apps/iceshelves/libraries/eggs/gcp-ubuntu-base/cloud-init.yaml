#cloud-config
# GCP Compute Engine Ubuntu 24.04 LTS Base
# Minimal cloud-init configuration for GCP VM instances

hostname: gcp-ubuntu-base
timezone: UTC
locale: en_US.UTF-8

# Update packages on first boot
package_update: true
package_upgrade: true

# Install essential packages
packages:
  - vim
  - curl
  - wget
  - git
  - htop
  - google-cloud-sdk
  - python3-pip

# Users - GCP creates default user based on SSH keys
# Additional configuration for existing user
users:
  - name: ubuntu
    groups: sudo, google-sudoers
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

# SSH configuration
ssh_pwauth: false
disable_root: true

# Write custom MOTD
write_files:
  - path: /etc/motd
    content: |
      ╔═══════════════════════════════════════════════════════════╗
      ║                                                           ║
      ║   🧊 Deployed with IceShelves - GCP Compute Ubuntu Base   ║
      ║                                                           ║
      ║   Ubuntu 24.04 LTS on Google Cloud Platform             ║
      ║   Managed by: IceShelves Deployment Platform            ║
      ║                                                           ║
      ╚═══════════════════════════════════════════════════════════╝
    permissions: '0644'

  - path: /etc/profile.d/gcp-environment.sh
    content: |
      # GCP Environment Variables
      export GCP_PROJECT_ID=$(curl -s "http://metadata.google.internal/computeMetadata/v1/project/project-id" -H "Metadata-Flavor: Google")
      export GCP_ZONE=$(curl -s "http://metadata.google.internal/computeMetadata/v1/instance/zone" -H "Metadata-Flavor: Google" | cut -d/ -f4)
      export GCP_INSTANCE_NAME=$(curl -s "http://metadata.google.internal/computeMetadata/v1/instance/name" -H "Metadata-Flavor: Google")
    permissions: '0644'

# Run commands on first boot
runcmd:
  - echo "IceShelves deployment completed at $(date)" >> /var/log/iceshelves-deployment.log
  - systemctl enable ssh
  - systemctl start ssh
  # Configure gcloud CLI
  - gcloud config set project $(curl -s "http://metadata.google.internal/computeMetadata/v1/project/project-id" -H "Metadata-Flavor: Google")
  - gcloud config set compute/zone $(curl -s "http://metadata.google.internal/computeMetadata/v1/instance/zone" -H "Metadata-Flavor: Google" | cut -d/ -f4)

# Set up automatic security updates
apt:
  sources:
    ubuntu-security:
      source: "deb http://security.ubuntu.com/ubuntu noble-security main restricted universe multiverse"

final_message: "IceShelves GCP Compute deployment completed successfully! Uptime: $UPTIME"

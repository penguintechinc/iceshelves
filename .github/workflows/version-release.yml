name: Create Release on Version Change

on:
  push:
    branches:
      - main
    paths:
      - '.version'  # Trigger only on .version file changes (epoch64 monitoring)

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if .version file exists
        id: check_version
        run: |
          if [ ! -f .version ]; then
            echo "0.0.0" > .version
            echo "version=0.0.0" >> $GITHUB_OUTPUT
            echo "full_version=0.0.0" >> $GITHUB_OUTPUT
            echo "epoch64=" >> $GITHUB_OUTPUT
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            # Read .version file and remove whitespace
            VERSION=$(cat .version | tr -d '[:space:]')

            # Validate format: vMajor.Minor.Patch.epoch64
            # Example: 1.0.0.1737727200
            if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
              echo "Invalid version format: $VERSION (expected vMajor.Minor.Patch[.epoch64])"
              exit 1
            fi

            # Extract semantic version (first 3 segments)
            SEMVER=$(echo "$VERSION" | cut -d'.' -f1-3)

            # Extract epoch64 (4th segment if present) - Unix timestamp
            EPOCH64=$(echo "$VERSION" | cut -d'.' -f4 -s)
            if [ -z "$EPOCH64" ]; then
              # If no epoch64, use current Unix timestamp
              EPOCH64=$(date +%s)
            fi

            echo "version=$SEMVER" >> $GITHUB_OUTPUT
            echo "full_version=$VERSION" >> $GITHUB_OUTPUT
            echo "epoch64=$EPOCH64" >> $GITHUB_OUTPUT

            # Check if version is default (0.0.0)
            if [ "$SEMVER" = "0.0.0" ]; then
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "Version is default (0.0.0), skipping release"
            else
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "Version is $SEMVER with epoch64=$EPOCH64, proceeding with release"
            fi
          fi

      - name: Check if release already exists
        id: check_release
        if: steps.check_version.outputs.should_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.check_version.outputs.version }}"
          if gh release view "v$VERSION" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release v$VERSION already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release v$VERSION does not exist, will create"
          fi

      - name: Generate release notes
        id: release_notes
        if: steps.check_version.outputs.should_release == 'true' && steps.check_release.outputs.exists != 'true'
        run: |
          VERSION="${{ steps.check_version.outputs.version }}"
          FULL_VERSION="${{ steps.check_version.outputs.full_version }}"
          EPOCH64="${{ steps.check_version.outputs.epoch64 }}"

          # Convert epoch64 to human-readable date
          if command -v date &> /dev/null; then
            BUILD_DATE=$(date -d @${EPOCH64} -u +"%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || date -u -r ${EPOCH64} +"%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "Build timestamp: ${EPOCH64}")
          else
            BUILD_DATE="Build timestamp: ${EPOCH64}"
          fi

          # Create release notes
          cat << EOF > release_notes.md
          ## Release v$VERSION

          This is an automated release created from version file update.

          **Version Details:**
          - Semantic Version: \`$VERSION\`
          - Full Version: \`$FULL_VERSION\`
          - Epoch64 Timestamp: \`$EPOCH64\`
          - Build Date: $BUILD_DATE
          - Commit: \`${{ github.sha }}\`
          - Branch: \`${{ github.ref_name }}\`

          ### Cloud Deployment Management

          This release includes:
          - **Flask Backend**: Flask + PyDAL backend for auth, users, standard APIs
          - **Go Backend**: High-performance API for XDP/AF_XDP, NUMA operations
          - **WebUI**: React frontend with role-based access control
          - **Cloud Support**: AWS EC2, GCP Compute Engine, LXD, KVM
          - **Docker Images**: Multi-architecture (amd64, arm64)

          ### Installation

          Pull the latest Docker images:
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository }}:v$VERSION
          docker pull ghcr.io/${{ github.repository }}:$FULL_VERSION
          \`\`\`

          ### Deployment Agent

          Deploy the polling agent for air-gapped environments:
          \`\`\`bash
          python scripts/iceshelves-agent.py --server <manager-url> --token <api-token>
          \`\`\`

          ### Changes

          See commit history for detailed changes since last release.

          ---
          *This release was automatically generated when the .version file was updated.*
          EOF

      - name: Create pre-release
        if: steps.check_version.outputs.should_release == 'true' && steps.check_release.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.check_version.outputs.version }}"
          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --notes-file release_notes.md \
            --prerelease \
            --target ${{ github.sha }}

          echo "✅ Created pre-release v$VERSION"

      - name: Skip release (version is default or release exists)
        if: steps.check_version.outputs.should_release != 'true' || steps.check_release.outputs.exists == 'true'
        run: |
          if [ "${{ steps.check_version.outputs.should_release }}" != "true" ]; then
            echo "⏭️ Skipping release - version is 0.0.0 (default)"
          else
            echo "⏭️ Skipping release - v${{ steps.check_version.outputs.version }} already exists"
          fi
